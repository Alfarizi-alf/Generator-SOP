<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI SOP Generator (Baca File Otomatis)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Libraries for PDF & DOCX reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.5.1/mammoth.browser.min.js"></script>
    
    <!-- Libraries for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f3f4f6;
        }
        .form-label { 
            display: block; 
            font-weight: 500; 
            color: #374151; 
            margin-bottom: 0.5rem; 
        }
        .form-input, .form-textarea { 
            width: 100%; 
            border-radius: 0.5rem; 
            border: 1px solid #d1d5db; 
            padding: 0.5rem 0.75rem; 
            transition: border-color 0.2s, box-shadow 0.2s; 
            background-color: #f9fafb;
        }
        .form-input:focus, .form-textarea:focus { 
            outline: none; 
            border-color: #2563eb; 
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); 
            background-color: white;
        }
        .remove-btn { 
            background-color: #fee2e2; 
            color: #ef4444; 
            border-radius: 9999px; 
            width: 1.75rem; 
            height: 1.75rem; 
            flex-shrink: 0; 
            transition: all 0.2s; 
            border: none; 
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .remove-btn:hover { 
            background-color: #ef4444; 
            color: white;
        }
        .add-btn { 
            background-color: #e0f2f1;
            color: #0d9488;
            font-weight: 600;
            padding: 0.5rem 1rem; 
            border-radius: 0.5rem; 
            transition: background-color 0.2s; 
            border: 1px dashed #99f6e4;
            cursor: pointer; 
        }
        .add-btn:hover { 
            background-color: #ccfbf1;
            border-color: #5eead4;
        }
        
        /* Preview Styles */
        #sop-preview-container { 
            display: none; 
            position: sticky;
            top: 2rem;
        }
        .sop-document { 
            background: white; 
            border: 1px solid #e5e7eb; 
            padding: 2.5rem; 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05), 0 4px 6px -2px rgba(0,0,0,0.05);
            border-radius: 0.75rem;
        }
        .sop-header-table { 
            width: 100%; 
            border-collapse: collapse; 
            border: 2px solid black; 
            margin-bottom: 2rem; 
        }
        .sop-header-table td { 
            border: 1px solid black; 
            padding: 0.5rem; 
            vertical-align: top; 
        }
        .sop-header-table .logo-cell { 
            width: 25%; 
            text-align: center; 
            vertical-align: middle; 
            font-weight: bold; 
        }
        .sop-header-table .title-cell { 
            text-align: center; 
            font-weight: bold; 
            font-size: 1.25rem; 
            vertical-align: middle; 
        }
        .sop-section-title { 
            font-weight: bold; 
            font-size: 1.1rem; 
            margin-top: 1.5rem; 
            margin-bottom: 0.5rem; 
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.25rem;
        }
        .sop-content { 
            padding-left: 0.5rem; 
            text-align: justify; 
            color: #374151;
        }
        .sop-content ol, .sop-content ul { 
            padding-left: 1.5rem; 
        }
        .sop-content table { 
            width: 100%; 
            border-collapse: collapse; 
            border: 1px solid #6b7280; 
        }
        .sop-content th, .sop-content td { 
            border: 1px solid #d1d5db; 
            padding: 0.5rem; 
            text-align: left; 
        }
        .sop-content thead { 
            background-color: #f3f4f6; 
        }

        /* Flowchart Styles */
        .flowchart { display: flex; flex-direction: column; align-items: center; font-family: 'Courier New', monospace; padding: 1rem; }
        .flowchart-shape { border: 2px solid #1f2937; padding: 0.75rem 1.5rem; text-align: center; margin: 0 auto; background-color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .flowchart-process { border-radius: 0.25rem; }
        .flowchart-decision { transform: rotate(45deg); width: 180px; height: 180px; display: flex; align-items: center; justify-content: center; margin-top: 2rem; margin-bottom: 2rem; background-color: #eff6ff; border-color: #60a5fa; }
        .flowchart-decision-text { transform: rotate(-45deg); }
        .flowchart-arrow { text-align: center; margin: 0.5rem 0; font-size: 1.5rem; color: #6b7280; }
        .flowchart-branch-container { display: flex; justify-content: space-around; width: 120%; align-items: flex-start; position: relative; margin: 1rem 0;}
        .flowchart-branch { display: flex; flex-direction: column; align-items: center; width: 45%; }
        .branch-label { font-weight: bold; margin-bottom: 0.5rem; background-color: #f1f5f9; padding: 0.1rem 0.5rem; border-radius: 0.25rem; font-size: 0.8rem;}
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- API Key Modal -->
    <div id="api-key-modal" style="display: none;" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full transform transition-all" id="api-key-modal-content">
            <h2 class="text-2xl font-bold mb-2 text-gray-800">Masukkan API Key Gemini</h2>
            <p class="text-gray-600 mb-6">Untuk menggunakan fitur AI, Anda memerlukan Google AI API Key. Kunci ini akan disimpan di peramban Anda.</p>
            <div class="mb-4">
                <label for="api-key-input" class="form-label">API Key</label>
                <input type="password" id="api-key-input" class="form-input" placeholder="Masukkan API Key Anda di sini">
            </div>
            <p class="text-sm text-gray-500 mb-6">
                Belum punya kunci? Dapatkan di <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 font-semibold hover:underline">Google AI Studio</a>.
            </p>
            <button id="save-api-key-btn" class="w-full bg-blue-600 text-white font-bold py-2.5 rounded-lg hover:bg-blue-700 transition-all transform hover:scale-105">Simpan dan Mulai</button>
        </div>
    </div>

    <div id="main-container" class="max-w-7xl mx-auto lg:grid lg:grid-cols-12 lg:gap-8">
        <!-- INPUT FORM -->
        <div class="lg:col-span-7 bg-white p-6 rounded-xl shadow-lg">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-4">AI SOP Generator</h1>
            
            <form id="sop-form" class="space-y-8">
                <fieldset class="border border-gray-200 p-4 rounded-lg">
                    <legend class="px-2 font-semibold text-gray-700 text-lg">1. Informasi Utama</legend>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div><label for="fasyankes" class="form-label">Nama Fasyankes</label><input type="text" id="fasyankes" class="form-input" placeholder="Contoh: Puskesmas Cipta Sehat"></div>
                        <div><label for="kepala" class="form-label">Nama Kepala Fasyankes</label><input type="text" id="kepala" class="form-input" placeholder="Contoh: dr. Budi Santoso"></div>
                        <div><label for="no-dokumen" class="form-label">No. Dokumen</label><input type="text" id="no-dokumen" class="form-input" placeholder="SOP/UKP/RJ/01"></div>
                        <div><label for="no-revisi" class="form-label">No. Revisi</label><input type="text" id="no-revisi" class="form-input" placeholder="00"></div>
                        <div class="md:col-span-2"><label for="tgl-terbit" class="form-label">Tanggal Terbit</label><input type="date" id="tgl-terbit" class="form-input"></div>
                    </div>
                </fieldset>

                <fieldset class="border-2 border-blue-300 bg-blue-50 p-4 rounded-lg">
                    <legend class="px-2 font-semibold text-blue-800 text-lg">2. Konten SOP (Dibantu AI)</legend>
                    <div class="mt-4 space-y-4">
                        <div>
                            <label for="sop-title" class="form-label">Judul SOP <span class="text-red-500">*</span></label>
                            <input type="text" id="sop-title" class="form-input border-blue-300" placeholder="Ketik judul SOP untuk memulai...">
                        </div>
                        <div>
                            <label class="form-label">Konteks Tambahan dari File (Opsional)</label>
                            <!-- FILE UPLOAD SECTION -->
                            <div class="bg-white p-3 border border-dashed rounded-lg">
                                <input type="file" id="file-upload-input" class="block w-full text-sm text-slate-500
                                  file:mr-4 file:py-2 file:px-4
                                  file:rounded-md file:border-0
                                  file:text-sm file:font-semibold
                                  file:bg-blue-100 file:text-blue-700
                                  hover:file:bg-blue-200" accept=".txt,.pdf,.docx"/>
                                <p id="file-upload-info" class="text-xs text-gray-500 mt-2">Unggah file <code class="bg-gray-200 px-1 rounded">.txt</code>, <code class="bg-gray-200 px-1 rounded">.pdf</code>, atau <code class="bg-gray-200 px-1 rounded">.docx</code> untuk dibaca otomatis.</p>
                            </div>
                            <textarea id="sop-context" rows="5" class="form-textarea mt-2" placeholder="Atau tempelkan teks dari dokumen referensi Anda di sini..."></textarea>
                        </div>
                        <button id="generate-ai-btn" type="button" class="w-full bg-blue-600 text-white font-bold py-2.5 px-4 rounded-lg flex items-center justify-center gap-2 hover:bg-blue-700 transition-all transform hover:scale-105 disabled:bg-gray-400 disabled:scale-100">
                            <i class="fas fa-magic"></i> <span id="ai-btn-text">Hasilkan Draf dengan AI</span>
                        </button>
                        <p id="ai-error" class="hidden text-red-700 bg-red-100 border border-red-300 p-3 rounded-md text-sm mt-3"></p>
                    </div>
                    <div class="mt-6 space-y-6">
                        <div><label for="sop-pengertian" class="form-label">Pengertian</label><textarea id="sop-pengertian" rows="3" class="form-textarea"></textarea></div>
                        <div><label for="sop-tujuan" class="form-label">Tujuan</label><textarea id="sop-tujuan" rows="2" class="form-textarea"></textarea></div>
                        <div><label for="sop-kebijakan" class="form-label">Kebijakan</label><textarea id="sop-kebijakan" rows="2" class="form-textarea"></textarea></div>
                        <div><label for="sop-referensi" class="form-label">Referensi</label><textarea id="sop-referensi" rows="2" class="form-textarea"></textarea></div>
                        <div class="border border-gray-200 p-4 rounded-md bg-white">
                            <p class="font-semibold mb-3 text-base">Prosedur / Langkah-langkah</p>
                            <div class="space-y-4">
                                <div><label class="form-label text-sm font-semibold">a. Alat & Bahan</label><div id="alat-list" class="space-y-2"></div><button type="button" class="add-btn text-xs mt-2" data-type="alat"><i class="fas fa-plus mr-1"></i> Tambah Alat</button></div>
                                <div><label class="form-label text-sm font-semibold">b. Petugas Pelaksana</label><div id="petugas-list" class="space-y-2"></div><button type="button" class="add-btn text-xs mt-2" data-type="petugas"><i class="fas fa-plus mr-1"></i> Tambah Petugas</button></div>
                                <div><label class="form-label text-sm font-semibold">c. Langkah-langkah (Pola SPOK)</label><div id="langkah-list" class="space-y-3"></div><button type="button" class="add-btn text-xs mt-2" data-type="langkah"><i class="fas fa-plus mr-1"></i> Tambah Langkah</button></div>
                            </div>
                        </div>
                        <div><label for="sop-perhatian" class="form-label">Hal-hal yang perlu diperhatikan</label><textarea id="sop-perhatian" rows="2" class="form-textarea"></textarea></div>
                        <div><label for="sop-unit-terkait" class="form-label">Unit Terkait</label><textarea id="sop-unit-terkait" rows="2" class="form-textarea"></textarea></div>
                        <div><label for="sop-dokumen-terkait" class="form-label">Dokumen Terkait</label><textarea id="sop-dokumen-terkait" rows="2" class="form-textarea"></textarea></div>
                    </div>
                </fieldset>
                
                <fieldset class="border border-gray-200 p-4 rounded-lg">
                    <legend class="px-2 font-semibold text-gray-700 text-lg">3. Riwayat Revisi Dokumen</legend>
                    <div id="revisi-list" class="space-y-4 mt-4">
                        <!-- Revision items will be injected here by JavaScript -->
                    </div>
                    <button type="button" id="add-revisi-btn" class="add-btn text-sm mt-4"><i class="fas fa-plus mr-1"></i> Tambah Riwayat Revisi</button>
                </fieldset>

                 <div class="flex flex-col sm:flex-row gap-4 mt-8 border-t pt-6">
                    <button id="save-btn" type="button" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition-all transform hover:scale-105 flex items-center justify-center gap-2">
                        <i class="fas fa-save"></i> <span id="save-btn-text">Simpan Data</span>
                    </button>
                    <button id="preview-btn" type="button" class="w-full bg-teal-600 text-white font-bold py-3 rounded-lg hover:bg-teal-700 transition-all transform hover:scale-105 flex items-center justify-center gap-2">
                        <i class="fas fa-eye"></i> Tampilkan Pratinjau
                    </button>
                 </div>
            </form>
        </div>

        <div id="sop-preview-container" class="lg:col-span-5">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Pratinjau Dokumen</h2>
                <button id="download-pdf-btn" class="bg-gray-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-800 transition-all flex items-center justify-center gap-2 disabled:bg-gray-400">
                    <i id="pdf-btn-icon" class="fas fa-file-pdf"></i> <span id="pdf-btn-text">Unduh PDF</span>
                </button>
             </div>
             <div id="sop-preview" class="sop-document">
                <div id="preview-header"></div>
                <div id="preview-content"></div>
             </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    try {
        let apiKey = '';
        let listCounters = { alat: 0, petugas: 0, langkah: 0, revisi: 0 };

        const apiKeyModal = document.getElementById('api-key-modal');
        const apiKeyModalContent = document.getElementById('api-key-modal-content');
        const aiErrorEl = document.getElementById('ai-error');
        
        // Setup PDF.js worker
        if (window.pdfjsLib) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;
        }

        function checkApiKey() {
            apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                apiKeyModal.style.display = 'flex';
                setTimeout(() => apiKeyModalContent.style.opacity = 1, 10);
            } else {
                apiKeyModal.style.display = 'none';
            }
        }

        document.getElementById('save-api-key-btn').addEventListener('click', () => {
            const keyInput = document.getElementById('api-key-input').value;
            if (keyInput.trim()) {
                localStorage.setItem('geminiApiKey', keyInput.trim());
                apiKey = keyInput.trim();
                apiKeyModal.style.display = 'none';
            }
        });

        // --- UPDATED FILE READER ---
        document.getElementById('file-upload-input').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const contextTextArea = document.getElementById('sop-context');
            const infoEl = document.getElementById('file-upload-info');
            
            const setInfo = (message, type) => {
                infoEl.textContent = message;
                const colors = {
                    info: 'text-amber-600',
                    success: 'text-green-600',
                    error: 'text-red-600'
                };
                infoEl.className = `text-xs mt-2 ${colors[type] || 'text-gray-500'}`;
            };

            const fileExtension = file.name.split('.').pop().toLowerCase();
            setInfo(`Membaca file ${file.name}...`, 'info');
            contextTextArea.value = 'Sedang memproses file...';

            try {
                let text = '';
                if (fileExtension === 'txt') {
                    text = await file.text();
                } else if (fileExtension === 'docx') {
                    const arrayBuffer = await file.arrayBuffer();
                    const result = await mammoth.extractRawText({ arrayBuffer });
                    text = result.value;
                } else if (fileExtension === 'pdf') {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    let fullText = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        fullText += textContent.items.map(item => item.str).join(' ') + '\n';
                    }
                    text = fullText;
                } else {
                    throw new Error('Tipe file tidak didukung untuk pembacaan otomatis.');
                }
                
                contextTextArea.value = text;
                setInfo(`File ${file.name} berhasil dibaca.`, 'success');

            } catch (error) {
                console.error("File reading error:", error);
                contextTextArea.value = '';
                setInfo(`Gagal membaca file: ${error.message}`, 'error');
            }
        });

        function updateStepNumbers() {
            const stepItems = document.querySelectorAll('#langkah-list .step-number');
            stepItems.forEach((span, index) => { span.textContent = `${index + 1}.`; });
        }

        function addListItem(type, data = {}) {
            const container = document.getElementById(`${type}-list`);
            listCounters[type]++;
            const id = listCounters[type];
            const itemWrapper = document.createElement('div');
            itemWrapper.className = 'border-t border-gray-200 pt-3';
            itemWrapper.id = `${type}-item-${id}`;
            const isDecision = data.isDecision || false;
            
            let placeholderText = 'Tuliskan item...';
            if (type === 'langkah') placeholderText = 'Tulis langkah prosedur (Pola SPOK)...';
            else if (type === 'alat') placeholderText = 'Contoh: Spuit 3cc';
            else if (type === 'petugas') placeholderText = 'Contoh: Dokter, Perawat';

            itemWrapper.innerHTML = `
                <div class="flex items-start gap-3">
                    ${type === 'langkah' ? '<span class="step-number font-bold text-gray-500 pt-2 text-lg"></span>' : ''}
                    <div class="flex-grow">
                        <input type="text" class="form-input langkah-text" value="${data.text || ''}" placeholder="${placeholderText}">
                    </div>
                    ${type === 'langkah' ? `<div class="flex items-center pt-2 gap-2 flex-shrink-0"><input type="checkbox" id="is-decision-${id}" class="h-4 w-4 rounded text-blue-600 focus:ring-blue-500 is-decision-cb"><label for="is-decision-${id}" class="text-sm font-medium text-gray-700">Keputusan?</label></div>` : ''}
                    <button type="button" class="remove-btn self-center"><i class="fas fa-times"></i></button>
                </div>
                ${type === 'langkah' ? `<div id="decision-fields-${id}" class="mt-2 ml-10 space-y-2 ${isDecision ? '' : 'hidden'}"><label class="form-label text-xs font-semibold text-green-700">Jika YA:</label><input type="text" class="form-input text-sm decision-yes" value="${data.yes || ''}" placeholder="Tindakan jika YA..."><label class="form-label text-xs font-semibold text-red-700 mt-2">Jika TIDAK:</label><input type="text" class="form-input text-sm decision-no" value="${data.no || ''}" placeholder="Tindakan jika TIDAK..."></div>` : ''}`;
            
            container.appendChild(itemWrapper);
            if (isDecision) itemWrapper.querySelector('.is-decision-cb').checked = true;
            itemWrapper.querySelector('.remove-btn').addEventListener('click', () => { itemWrapper.remove(); if (type === 'langkah') updateStepNumbers(); });
            if (type === 'langkah') {
                itemWrapper.querySelector('.is-decision-cb').addEventListener('change', (e) => { 
                    itemWrapper.querySelector(`#decision-fields-${id}`).classList.toggle('hidden', !e.target.checked); 
                });
                updateStepNumbers();
            }
        }
        
        function addRevisionItem(data = {}) {
            const container = document.getElementById('revisi-list');
            listCounters.revisi++;
            const id = listCounters.revisi;
            const itemWrapper = document.createElement('div');
            itemWrapper.className = 'border-t border-gray-200 pt-4';
            itemWrapper.id = `revisi-item-${id}`;
            itemWrapper.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <p class="font-semibold text-gray-600">Revisi #${id}</p>
                    <button type="button" class="remove-btn"><i class="fas fa-times"></i></button>
                </div>
                <div class="space-y-3">
                    <div>
                        <label class="form-label text-sm">Yang diubah</label>
                        <input type="text" class="form-input text-sm revisi-ubah" value="${data.ubah || ''}" placeholder="Contoh: Prosedur Langkah 5">
                    </div>
                    <div>
                        <label class="form-label text-sm">Isi Perubahan</label>
                        <textarea class="form-textarea text-sm revisi-isi" rows="2" placeholder="Jelaskan perubahan yang dibuat...">${data.isi || ''}</textarea>
                    </div>
                    <div>
                        <label class="form-label text-sm">Tanggal Mulai Berlaku</label>
                        <input type="date" class="form-input text-sm revisi-tanggal" value="${data.tanggal || ''}">
                    </div>
                </div>`;
            container.appendChild(itemWrapper);
            itemWrapper.querySelector('.remove-btn').addEventListener('click', () => itemWrapper.remove());
        }

        function populateList(type, items) {
            const container = document.getElementById(`${type}-list`);
            container.innerHTML = '';
            listCounters[type] = 0;
            if (items && Array.isArray(items)) {
                items.forEach(item => {
                    if (typeof item === 'string') {
                        if (type === 'langkah' && item.startsWith('KEPUTUSAN:')) {
                            const parts = item.split('|');
                            const question = parts[0].replace('KEPUTUSAN:', '').trim();
                            const yesAction = parts[1]?.replace('YA:', '').trim() || '';
                            const noAction = parts[2]?.replace('TIDAK:', '').trim() || '';
                            addListItem(type, { text: question, isDecision: true, yes: yesAction, no: noAction });
                        } else { addListItem(type, { text: item }); }
                    } else { addListItem(type, item); }
                });
            }
        }

        document.addEventListener('click', (event) => {
            const addBtn = event.target.closest('.add-btn');
            if (addBtn) addListItem(addBtn.dataset.type);
        });
        
        document.getElementById('add-revisi-btn').addEventListener('click', () => addRevisionItem());

        document.getElementById('generate-ai-btn').addEventListener('click', async () => {
            const sopTitle = document.getElementById('sop-title').value.trim();
            if (!sopTitle) { 
                aiErrorEl.textContent = 'Judul SOP wajib diisi untuk menggunakan AI.'; 
                aiErrorEl.classList.remove('hidden');
                document.getElementById('sop-title').focus();
                return; 
            }
            aiErrorEl.classList.add('hidden');
            const btn = document.getElementById('generate-ai-btn');
            const btnText = document.getElementById('ai-btn-text');
            const btnIcon = btn.querySelector('i');
            btn.disabled = true;
            btnText.textContent = 'AI sedang memproses...';
            btnIcon.className = 'fas fa-spinner fa-spin';
            
            try {
                const sopContext = document.getElementById('sop-context').value.trim();
                let basePrompt = `Anda adalah seorang ahli dalam membuat Standar Operasional Prosedur (SOP) untuk fasilitas kesehatan di Indonesia. Berdasarkan judul SOP: "${sopTitle}", buatkan konten dalam format JSON. PENTING: Untuk bagian "langkah_langkah", setiap kalimat WAJIB mengikuti pola kalimat aktif SPO(K). Jika ada titik keputusan, GUNAKAN FORMAT KHUSUS berikut dalam satu string: "KEPUTUSAN: [Pertanyaan]? | YA: [Tindakan jika ya] | TIDAK: [Tindakan jika tidak]". Contoh: "KEPUTUSAN: Apakah ada darah dalam spuit? | YA: Petugas menarik kembali jarum dari kulit. | TIDAK: Petugas memasukkan obat secara perlahan.". Struktur JSON: { "pengertian": "...", "tujuan": "...", "kebijakan": "...", "referensi": ["..."], "prosedur": { "alat_bahan": ["..."], "petugas": ["..."], "langkah_langkah": ["Langkah 1 (SPOK)", "KEPUTUSAN: ...", "Langkah 3 (SPOK)"] }, "perhatian": "...", "unit_terkait": ["..."], "dokumen_terkait": ["..."] }`;

                if (sopContext) {
                    basePrompt += `\n\nSebagai tambahan, gunakan informasi dari teks berikut sebagai referensi utama dalam membuat konten SOP. Analisis teks ini dan ekstrak informasi yang relevan untuk setiap bagian dari SOP (pengertian, tujuan, langkah-langkah, dll.): \n\n--- KONTEKS TAMBAHAN DARI PENGGUNA ---\n${sopContext}\n--- AKHIR KONTEKS ---`;
                }
                
                const payload = { contents: [{ role: "user", parts: [{ text: basePrompt }] }], generationConfig: { responseMimeType: "application/json" } };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                
                if (!response.ok) {
                    let errorText = `Gagal menghubungi AI (Status: ${response.status}).`;
                    try {
                        const errorData = await response.json();
                        if (errorData.error && errorData.error.message) errorText = `Error dari API: ${errorData.error.message.replace(/\s*\[\s*400\s*\]\s*$/, '')}`;
                    } catch (e) { /* Ignore */ }
                    throw new Error(errorText);
                }

                const result = await response.json();
                if (!result.candidates?.[0]?.content?.parts?.[0]?.text) throw new Error("Respons AI tidak valid atau kosong.");
                
                const data = JSON.parse(result.candidates[0].content.parts[0].text);
                document.getElementById('sop-pengertian').value = data.pengertian || '';
                document.getElementById('sop-tujuan').value = data.tujuan || '';
                document.getElementById('sop-kebijakan').value = data.kebijakan || '';
                document.getElementById('sop-referensi').value = (data.referensi || []).join('\n');
                document.getElementById('sop-perhatian').value = data.perhatian || '';
                document.getElementById('sop-unit-terkait').value = (data.unit_terkait || []).join(', ');
                document.getElementById('sop-dokumen-terkait').value = (data.dokumen_terkait || []).join(', ');
                populateList('alat', data.prosedur?.alat_bahan);
                populateList('petugas', data.prosedur?.petugas);
                populateList('langkah', data.prosedur?.langkah_langkah);

            } catch (error) {
                console.error(`AI Generation failed:`, error);
                aiErrorEl.innerHTML = `${error.message}<br>Pastikan API Key Anda benar dan coba lagi nanti.`;
                aiErrorEl.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Hasilkan Draf dengan AI';
                btnIcon.className = 'fas fa-magic';
            }
        });

        function collectAllData() {
            // ... (Fungsi ini tidak perlu diubah)
            return {
                fasyankes: document.getElementById('fasyankes').value, kepala: document.getElementById('kepala').value, judul: document.getElementById('sop-title').value, noDokumen: document.getElementById('no-dokumen').value, noRevisi: document.getElementById('no-revisi').value, tglTerbit: document.getElementById('tgl-terbit').value, pengertian: document.getElementById('sop-pengertian').value, tujuan: document.getElementById('sop-tujuan').value, kebijakan: document.getElementById('sop-kebijakan').value, referensi: document.getElementById('sop-referensi').value, perhatian: document.getElementById('sop-perhatian').value, unitTerkait: document.getElementById('sop-unit-terkait').value, dokumenTerkait: document.getElementById('sop-dokumen-terkait').value,
                alat: Array.from(document.querySelectorAll('#alat-list input')).map(i => i.value).filter(Boolean),
                petugas: Array.from(document.querySelectorAll('#petugas-list input')).map(i => i.value).filter(Boolean),
                langkah: Array.from(document.querySelectorAll('#langkah-list > div')).map(div => ({ isDecision: div.querySelector('.is-decision-cb').checked, text: div.querySelector('.langkah-text').value, yes: div.querySelector('.decision-yes').value, no: div.querySelector('.decision-no').value })),
                revisi: Array.from(document.querySelectorAll('#revisi-list > div')).map(div => ({ ubah: div.querySelector('.revisi-ubah').value, isi: div.querySelector('.revisi-isi').value, tanggal: div.querySelector('.revisi-tanggal').value }))
            };
        }

        function saveSOP() {
            // ... (Fungsi ini tidak perlu diubah)
            const data = collectAllData();
            localStorage.setItem('savedSOPData', JSON.stringify(data));
            const btn = document.getElementById('save-btn');
            const btnText = document.getElementById('save-btn-text');
            const originalText = btnText.textContent;
            btn.classList.add('bg-green-600', 'hover:bg-green-700');
            btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            btnText.textContent = 'Data Tersimpan!';
            setTimeout(() => { 
                btnText.textContent = originalText;
                btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                btn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            }, 2500);
        }

        function loadSOP() {
            // ... (Fungsi ini tidak perlu diubah)
            const savedData = localStorage.getItem('savedSOPData');
            if (!savedData) return;
            let data;
            try { data = JSON.parse(savedData); } catch (e) { console.error("Gagal memuat data SOP:", e); localStorage.removeItem('savedSOPData'); return; }
            if (!data) return;
            document.getElementById('fasyankes').value = data.fasyankes || ''; document.getElementById('kepala').value = data.kepala || ''; document.getElementById('sop-title').value = data.judul || ''; document.getElementById('no-dokumen').value = data.noDokumen || ''; document.getElementById('no-revisi').value = data.noRevisi || ''; document.getElementById('tgl-terbit').value = data.tglTerbit || ''; document.getElementById('sop-pengertian').value = data.pengertian || ''; document.getElementById('sop-tujuan').value = data.tujuan || ''; document.getElementById('sop-kebijakan').value = data.kebijakan || ''; document.getElementById('sop-referensi').value = data.referensi || ''; document.getElementById('sop-perhatian').value = data.perhatian || ''; document.getElementById('sop-unit-terkait').value = data.unitTerkait || ''; document.getElementById('sop-dokumen-terkait').value = data.dokumenTerkait || '';
            populateList('alat', data.alat ? data.alat.map(t => ({text: t})) : []);
            populateList('petugas', data.petugas ? data.petugas.map(t => ({text: t})) : []);
            populateList('langkah', data.langkah || []);
            const revisiContainer = document.getElementById('revisi-list');
            revisiContainer.innerHTML = ''; listCounters.revisi = 0;
            if (data.revisi && Array.isArray(data.revisi)) data.revisi.forEach(item => addRevisionItem(item));
        }

        function renderPreview() {
            // ... (Fungsi ini tidak perlu diubah)
            document.getElementById('sop-preview-container').style.display = 'block';
            const data = collectAllData();
            const formatDate = (d) => d ? new Intl.DateTimeFormat('id-ID',{day:'2-digit',month:'long',year:'numeric'}).format(new Date(d)) : '';
            document.getElementById('preview-header').innerHTML = `<table class="sop-header-table"><tr><td rowspan="2" class="logo-cell">LOGO</td><td rowspan="2" class="title-cell">${data.judul||'JUDUL SOP'}</td><td>No. Dokumen: ${data.noDokumen}</td></tr><tr><td>No. Revisi: ${data.noRevisi}</td></tr><tr><td class="text-center font-bold">${data.fasyankes||'Nama Fasyankes'}</td><td class="text-center"><b>STANDAR OPERASIONAL PROSEDUR</b></td><td>Tgl. Terbit: ${formatDate(data.tglTerbit)}</td></tr><tr><td class="text-center">Disahkan oleh,<br>Kepala ${data.fasyankes||''}<br><br><br><br><b><u>${data.kepala||'Nama Kepala'}</u></b></td><td></td><td>Halaman: 1/1</td></tr></table>`;
            let flowchartHTML = '';
            data.langkah.forEach((step, index) => {
                if (step.isDecision) {
                    flowchartHTML += `<div class="flowchart-shape flowchart-decision"><div class="flowchart-decision-text">${step.text}</div></div><div class="flowchart-branch-container"><div class="flowchart-branch"><div class="branch-label">YA</div><div class="flowchart-arrow">▼</div><div class="flowchart-shape flowchart-process">${step.yes||'Lanjut'}</div></div><div class="flowchart-branch"><div class="branch-label">TIDAK</div><div class="flowchart-arrow">▼</div><div class="flowchart-shape flowchart-process">${step.no||'Lanjut'}</div></div></div>`;
                } else { flowchartHTML += `<div class="flowchart-shape flowchart-process">${step.text}</div>`; }
                if (index < data.langkah.length - 1) flowchartHTML += `<div class="flowchart-arrow">▼</div>`;
            });
            const revisiTableHTML = `
                <table class="w-full border-collapse border border-gray-400 mt-2"><thead class="bg-gray-100"><tr><th class="border p-2 text-left">Yang diubah</th><th class="border p-2 text-left">Isi Perubahan</th><th class="border p-2 text-left">Tgl. Mulai Berlaku</th></tr></thead>
                <tbody>${data.revisi.length>0?data.revisi.map(r=>`<tr><td class="border p-2">${r.ubah||''}</td><td class="border p-2">${r.isi||''}</td><td class="border p-2">${formatDate(r.tanggal)||''}</td></tr>`).join(''):'<tr><td colspan="3" class="p-2 text-center text-gray-500">Tidak ada riwayat revisi.</td></tr>'}</tbody></table>`;
            const toHtmlList = (items) => items.length > 0 ? `<ul>${items.map(i => `<li>${i}</li>`).join('')}</ul>` : '<p class="text-gray-500 italic">Tidak ada</p>';
            const toHtmlSteps = (items) => items.length > 0 ? `<ol>${items.map(s => `<li>${s.text}${s.isDecision ? ` (Ya: ${s.yes}, Tidak: ${s.no})` : ''}</li>`).join('')}</ol>` : '<p class="text-gray-500 italic">Tidak ada</p>';
            const textToHtml = (text) => text ? text.replace(/\n/g, '<br>') : '<p class="text-gray-500 italic">Tidak ada</p>';
            document.getElementById('preview-content').innerHTML = `<div><p class="sop-section-title">1. Pengertian</p><div class="sop-content">${textToHtml(data.pengertian)}</div></div><div><p class="sop-section-title">2. Tujuan</p><div class="sop-content">${textToHtml(data.tujuan)}</div></div><div><p class="sop-section-title">3. Kebijakan</p><div class="sop-content">${textToHtml(data.kebijakan)}</div></div><div><p class="sop-section-title">4. Referensi</p><div class="sop-content">${textToHtml(data.referensi)}</div></div><div><p class="sop-section-title">5. Prosedur</p><div class="sop-content"><p class="font-semibold">a. Alat & Bahan</p>${toHtmlList(data.alat)}<p class="font-semibold mt-2">b. Petugas</p>${toHtmlList(data.petugas)}<p class="font-semibold mt-2">c. Langkah-langkah</p>${toHtmlSteps(data.langkah)}</div></div><div><p class="sop-section-title">6. Bagan Alir</p><div class="sop-content flowchart">${flowchartHTML||'<p class="italic">...</p>'}</div></div><div><p class="sop-section-title">7. Hal-hal yang perlu diperhatikan</p><div class="sop-content">${textToHtml(data.perhatian)}</div></div><div><p class="sop-section-title">8. Unit Terkait</p><div class="sop-content">${textToHtml(data.unitTerkait)}</div></div><div><p class="sop-section-title">9. Dokumen Terkait</p><div class="sop-content">${textToHtml(data.dokumenTerkait)}</div></div><div><p class="sop-section-title">10. Riwayat Revisi</p><div class="sop-content">${revisiTableHTML}</div></div>`;
            document.getElementById('sop-preview-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        async function downloadPDF() {
            // ... (Fungsi ini tidak perlu diubah)
            const downloadBtn = document.getElementById('download-pdf-btn');
            const btnText = document.getElementById('pdf-btn-text');
            const btnIcon = document.getElementById('pdf-btn-icon');
            downloadBtn.disabled = true;
            btnText.textContent = 'Memproses...';
            btnIcon.className = 'fas fa-spinner fa-spin';
            try {
                const data = collectAllData();
                const elementToCapture = document.getElementById('sop-preview');
                const canvas = await html2canvas(elementToCapture, { scale: 2, useCORS: true });
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const imgProps = pdf.getImageProperties(imgData);
                const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
                let heightLeft = imgHeight;
                let position = 0;
                pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                heightLeft -= pdf.internal.pageSize.getHeight();
                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                    heightLeft -= pdf.internal.pageSize.getHeight();
                }
                pdf.save(`SOP-${data.judul || 'Dokumen'}.pdf`);
            } catch (error) {
                console.error("Gagal membuat PDF:", error);
                alert("Gagal membuat file PDF.");
            } finally {
                downloadBtn.disabled = false;
                btnText.textContent = 'Unduh PDF';
                btnIcon.className = 'fas fa-file-pdf';
            }
        }

        // Attach all event listeners
        document.getElementById('save-btn').addEventListener('click', saveSOP);
        document.getElementById('preview-btn').addEventListener('click', renderPreview);
        document.getElementById('download-pdf-btn').addEventListener('click', downloadPDF);

        // Initialize the application
        checkApiKey();
        loadSOP();
        if (document.querySelectorAll('#langkah-list > div').length === 0) addListItem('langkah');
        if (document.querySelectorAll('#alat-list > div').length === 0) addListItem('alat');
        if (document.querySelectorAll('#petugas-list > div').length === 0) addListItem('petugas');
        
    } catch (e) {
        console.error("Terjadi kesalahan fatal saat inisialisasi aplikasi:", e);
        document.body.innerHTML = `<div class="p-8 bg-red-100 text-red-800 border-4 border-dashed border-red-300 m-8 rounded-lg">
            <h1 class="text-2xl font-bold">Aplikasi Gagal Dimuat</h1>
            <p class="mt-2">Mohon maaf, terjadi kesalahan fatal yang mencegah aplikasi berjalan.</p>
            <p class="mt-4"><b>Saran:</b> Coba bersihkan cache dan data situs untuk halaman ini, lalu muat ulang.</p>
            <hr class="my-4 border-red-300">
            <p class="font-mono text-sm">Detail Kesalahan: ${e.message}</p>
        </div>`;
    }
});
</script>
</body>
</html>
